## Документация к серверу
## Содержание
- [Ограничения](#ограничения)
- [Формат входящих/исходящих сообщений](#формат-входящихисходящих-сообщений)
- [Формат профиля](#формат-профиля)
- [Формат запросов/ответов](#формат-запросовответов)
  - [Запросы](#запросы)
  - [Ответы](#ответы)
  - [Ошибки](#ошибки)
  - [Синтаксис](#синтаксис)
    - [!ping](#ping)
    - [!contact](#contact)
    - [!login](#login)
    - [!register](#register)
    - [!join](#join)
    - [!leave](#leave)
    - [!create](#create)
    - [!profile](#profile)
    - [!chat](#chat)
    - [!read](#read)
    - [!unread](#unread)
    - [!msg](#msg)
    - [!getUnread](#getunread)


# Ограничения

Здесь перечислены все возможные ограничения

1) максимальное количество символов (байт) в отправляемом/получаемом пакете - 115000
2) максимальная длина имени пользователя/канала - 32 символа
3) максимальное количество символов в поле профиля - 128
4) все имена пользователей начинаются с `@`
5) имя пользователя не может содержать следующие символы: 
```
(пробел) 
! # $ % ^ & * ( ) -
= + [ ] { } ` ~ ' "
< > ? , . / | \ : ;
```
6) имя пользователя не может быть `@admin`, `@browser`, `@server`, `@all`
7) все имена каналов начинаются с `:`
8) имя канала не может содержать из списка для имен пользователя (кроме `:`), а так же `@`
9) имя канала не может быть `:server`, `:browser`
10) правила на имена пользователей не действуют на служебных пользователей (таких как `!server`)

# Формат входящих/исходящих сообщений

Сервер принимает только этот формат сообщений, остальные - игнорируются

1) первые 20 символов должны быть строковым представлением ID сообщения (у исходящих сообщений равен нулю), причем если ID меньше 20-ти символов, оставшиеся символы должны быть заполнены ведущими нулями.
2) следующие 10 символов - строковое представление даты отправки сообщения в секундах с 1 января 1970 00:00:00 UTC (epoch time).
3) следующие 32 символа - имя пользователя (username) отправителя сообщения, если имя пользователя меньше 32 символов, ведущие символы должны быть заполнены пробелами (ascii: 32).
4) аналогично следующие 32 символа - имя пользователя (username/channel/special) получателя сообщения. действуют те же правила, однако не действует ограничение на имена пользоваетлей, если имя начинается с воклицательного знака (ascii: 33).
5) все символы далее (1024 максимум, кроме [одного случая](#chat)) - само сообщение (пока что в незашифрованном виде)

итоговый вид сообщения:\
`< 20 id | 10 datetime | 32 sender | 32 destination | 1024 message >`

# Формат профиля

Профили на сервере хранятся и передаются в следующем формате:\
профиль имеет поля *description (string)*, *email (string)*, *realName (string)*, *birthday (int)*, в будущем могут быть еще поля. они записываются в формате: *`поле_1`* + *`разделитель`* + *`поле_2`* + *`разделитель`* + ...\
разделителем является символ ascii №29 (`"\u001D"` JS/TS). поля идут в том порядке, в каком они указаны здесь

# Формат запросов/ответов

## Запросы
Запросы осуществляются как обычные сообщения из блока выше, но получателем является особый пользователь **`!server.req`**.

## Ответы
Ответы так же являются обычными сообщениями, однако их message-составляющая (последние 1024 символа) является особым форматом:\
с начала идет строка `REQ:`, далее сам запрос (то сообщение, что вы отправили на сервер), далее идет специальный символ-разделитель (Record-separator, ascii: 30, `"\u001E"` JS/TS), затем строка `RSP:` , после которой непосредственно ответ на запрос.\
**!!! ВАЖНО !!!**\
формат ответа (RSP) может отличаться от команды к команде, это лишь глобальный формат общего ответа, RSP придется обрабатывать отдельно в зависимости от самого запроса.

## Ошибки
Сервер может отправлять ошибки, в таком случае клиент должен вывести сообщение о ней.\
Ошибки - это обычные сообщения, но от пользователя **`!server.error`**, сообщения об ошибке храниться в message-составляющей сообщения.

## Синтаксис
Синтаксис команд и формат ответа от них

### !ping
    !ping
не принимает аргументов, сервер всегда возвращает строку `pong`. используется для проверки соединения (Debug)

**Пример:**
```
!ping
```

### !contact
    !contact <action> <arg> <name?>

*Операции с контактами*\
всегда принимает первым аргуметом действие, а далее в зависимости от действия:
 - `add`: **добавляет пользователя в контакты с заданным именем.** первый аргумент - имя пользователя, для добавления в контакты; второй - имя контакта. ***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***
 - `rem`: **удаляет контакт по у пользователя.** первый аргумент - имя пользователя, для удаления контакта. ***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***
 - `get`: **получить сохраненное имя контакта у пользователя.** первый аргумент - имя пользователя, для получения контакта. ***ВОЗВРАЩАЕТ: сохранненое имя контакта или пустую строку***

### !login
    !login <username> <password_hash>

*Вход в аккаунт*
всегда принимает логин и хэш пароля

***ВОЗВРАЩАЕТ: `success` если успешно, `fail_username` - ошибка в имени пользователя, `fail_password` - неверный пароль***

### !register
    !register <username> <password_hash>

*Регистрация аккаунта*
всегда принимает логин и хэш пароля

***ВОЗВРАЩАЕТ: `success` если успешно, `fail_username` - ошибка в имени пользователя (уже существует)***

### !join
    !join <channel>

*Присоединиться к каналу*
всегда принимает имя канала

***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***

### !leave
    !leave <channel>

*Покинуть канал*
всегда принимает имя канала

***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***

### !create
    !create <channel>

*Создать канал*
всегда принимает имя канала

***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***

### !profile
    !profile <action> <user> <arg?>

*Управление / просмотр профиля*
зависит от action:
 - `set`: задать профиль. принимает еще [payload-преобазование профиля](#формат-профиля) ***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***
 - `get`: ***ВОЗВРАЩАЕТ: [payload-преобазование профиля](#формат-профиля)***

### !chat
    !chat <chat> <lines>

*Посмотреть историю сообщений*
всегда принимает имя канала/пользователя и количество сообщений

***ВОЗВРАЩАЕТ: сообщения в стандартном формате, но разделенных Unit-separator (ascii: 31, `"\u001E"` JS/TS)***

### !read
    !read <chat> <id>

*Пометить как прочитанное*
принимает имя чата и ID сообщения

***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***

### !unread
    !unread <chat> <id>

*Пометить как непрочитанное*
принимает имя чата и ID сообщения

***ВОЗВРАЩАЕТ: `+` если успешно, иначе `-`***

### !msg
    !msg <chat> <id>

*Получить сообщение по ID*
принимает имя чата и ID сообщения

***ВОЗВРАЩАЕТ: сообщение в стандартном формате**

### !getUnread
    !getUnread

*Получить непрочитанные сообщения*
ничего не принимает

***ВОЗВРАЩАЕТ: непрочитанные сообщения в формате: `msg_chat1|msg_id1;msg_chat2|msg_id2;msg_chat3|msg_id3; ...` (записи разделены точкой с запятой, в начале записи имя чата, затем палочка (вертикальная, не `/`) затем ID сообщения)***